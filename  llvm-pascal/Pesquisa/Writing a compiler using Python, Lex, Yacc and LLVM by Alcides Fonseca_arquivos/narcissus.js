var Dsq;if(typeof Dsq=="undefined"){Dsq={}}Dsq.NewFrames=function(a){this.url=a};Dsq.NewFrames.prototype.init=function(a){var b=this;try{this.messenger=new ParentMessenger(this.url,Dsq.jsonData.integration.receiver_url,this.container,this.receive_callback)}catch(c){if(typeof a=="function"){a()}}if(typeof a=="function"){var d=window.setInterval(function(){if(typeof b.messenger=="undefined"){window.clearInterval(d);return}if(b.messenger._ready){window.clearInterval(d)}else{if(b.messenger._error){window.clearInterval(d);a()}}},10)}};Dsq.NewFrames.prototype._execute=function(d,a,c){var b=this;if(typeof b.messenger=="undefined"){return false}JsonRpc.execute(function(e){b.messenger.sendMessage(e)},d,a||[],c);return true};Dsq.ReplyFrame=function(b,i){var f=this;this.container=b;this.parent_post_id=i;var k=function(m){Dsq.Debug.log("Dsq.ReplyFrame.sendFunc");f.messenger.sendMessage(m)};var e=function(m){Dsq.jsonData.posts[m.message.id]=m.message.post_meta;if(!Dsq.jsonData.users[m.message.post_meta.user_key]){Dsq.jsonData.users[m.message.post_meta.user_key]=m.message.user_meta}var n=(typeof(disqus_insert_wrt_sort)=="undefined"?(Dsq.jsonData.forum.reply_position?-1:null):(Dsq.jsonData.request.sort==2?null:-1));if(m.message.post_meta.approved){Dsq.Post.insert(m.message.post_meta.parent_post_id||n,m.message.id,m.message.post_meta.message)}Dsq.Templates.postComment_onSuccess(m,i,m.message.id)};var g=function(m){Dsq.Popup.popModal(m.message,"Error");Dsq.Templates.postComment_onFailure(m,i,m.message.id)};var h=function(m){var n=i;var o=Dsq.$("dsq-comment-message-"+n);o.innerHTML=m.message;Dsq.Templates.toggleEdit(n);Dsq.Templates.setLoadingButton(false)};var l=function(m){var n=i;Dsq.Popup.popModal("Sorry, there was an error editing this comment.","Edit Error");Dsq.Templates.toggleEdit(n);Dsq.Templates.setLoadingButton(false)};var d=function(n){var o=n.message;var m=Dsq.Templates.getFormFields(i);if(o.username){Dsq.Templates.lightboxAuthenticate(i,"login",{username:o.username,display_name:o.display_name,avatar_url:o.avatar_url,verified:o.verified,email:m.email.value})}else{Dsq.Templates.lightboxAuthenticate(i,"register")}};var j=function(m,n){Dsq.Templates.postComment(i,null,true,n)};var a=function(o,t){var n=i?"-"+i:"";var s=o.message;if(t=="register"){var m=["email","username","password"];for(var p=0;p<m.length;p++){var r=m[p];var q=Dsq.$("dsq-"+r+"-errors"+n);if(s[r]){q.innerHTML=s[r]}else{q.innerHTML=""}}}else{if(t=="login"){Dsq.$("dsq-lightbox-errors"+n).innerHTML="<p>We couldn't log you in. Please verify your login.</p>"}}Dsq.Templates.setLoadingButton(false)};var c=function(m){Dsq.Templates.cookieFailure(m)};this.receive_callback=JsonRpc.createHandler(k,{"postComment.onSuccess":e,"postComment.onFailure":g,"editComment.onSuccess":h,"editComment.onFailure":l,"getUserByEmail.onSuccess":d,"validateAuth.onSuccess":j,"validateAuth.onFailure":a,cookieFailure:c,reload:function(){window.location.reload()}});this.url=Dsq.Urls.REPLY+"?"+(new Date()).getTime()+"&f="+Dsq.jsonData.forum.url+"&t="+Dsq.jsonData.thread.slug+"&ff="+Dsq.Thread.ff+"&default_text="+encodeURIComponent(disqus_default_text)+"&ifrs="+encodeURIComponent(disqus_iframe_css);if(this.parent_post_id){this.url+="&parent_post="+this.parent_post_id}};Dsq.ReplyFrame.prototype=new Dsq.NewFrames(Dsq.ReplyFrame.url);Dsq.ReplyFrame.prototype.post=function(e,c,d,b,f,a){this._execute("postComment",[e,c,d,b,f,a])};Dsq.ReplyFrame.prototype.edit=function(a,b){this._execute("editComment",[a,b])};Dsq.ReplyFrame.prototype.setState=function(a,b){this._execute("setState",[a,b])};Dsq.ReplyFrame.prototype.getUserByEmail=function(a){this._execute("getUserByEmail",[a])};Dsq.ReplyFrame.prototype.validateAuth=function(c,b,d,a){this._execute("validateAuth",[c,b,d,a])};Dsq.ReplyFrame.prototype.authenticateFacebook=function(b,a){this._execute("authenticateFacebook",[b,a])};var Dsq;if(typeof Dsq=="undefined"){Dsq={}}Dsq.Facebook=function(){var c=this;var a=function(e){var d=Dsq.jsonData.forum.url;if(typeof disqus_facebook_forum!="undefined"){d=disqus_facebook_forum}Dsq.frames.reply_0.authenticateFacebook(e,d)};var b=function(){FB.Connect.getSignedPublicSessionData(a)};this.login=function(){FB.Connect.requireSession(b,true)}};Dsq.Facebook=new Dsq.Facebook();var FragmentPacket=function(a,f,d,c,b){var e=this;this.reader=a;this.writer=f;this.writer_url=d;this.is_child=c||false;this.receiveCallback=b;this._lastHash=null;this._accumMsg="";this._lastSeqno=0;this.MAX_DATA_LEN=1024;this.WAIT_TIME=10;this.READY=1;this.WRITING=2;this.FIN=4;this.ACK=8};FragmentPacket.prototype.createListener=function(){var a=this;var b=function(){try{a.recv()}catch(c){if(!Dsq.Utils.browser.ie){throw (c)}}};return window.setInterval(b,10)};FragmentPacket.prototype.log=function(a){};FragmentPacket.prototype.recv=function(){var d;if(/MSIE/.test(navigator.userAgent)){d=this.reader.name}else{var b=this.reader.location.href.indexOf("#");if(b==-1){return null}d=this.reader.location.href.substring(b+1)}var a=parseInt(d.substring(0,4),10);var e=parseInt(d.substring(4,24),10);var c=d.substring(24);if(this._lastHash!==d){this._lastHash=d;this.log("recv: "+d);this.log(" flags: "+a);this.log(" seqno: "+e+" len: "+d.substring(4,24).length+" ("+d.substring(4,24)+")");this.log(" data: "+c+" len: "+c.length);this._lastSeqno=e;if(a&this.WRITING){this._accumMsg+=c;this.sendFlag(this.ACK,e);if(a&this.FIN){this.log("recv finished: "+decodeURIComponent(this._accumMsg));this.receiveCallback(decodeURIComponent(this._accumMsg));this._accumMsg="";this.sendFlag(this.READY|this.ACK,this._lastSeqno)}}}return{flags:a,seqno:e,data:c}};FragmentPacket.prototype.sendRawPacket=function(a){if(/MSIE/.test(navigator.userAgent)){this.writer.name=a}else{this.writer.location.href=this.writer_url+"#"+a}};FragmentPacket.prototype.sendFlag=function(a,b){this.sendRawPacket(this._zerofill(a,4)+this._zerofill(b,20))};FragmentPacket.prototype.send=function(a){this._send(0,encodeURIComponent(a))};FragmentPacket.prototype._send=function(h,g){var c=this;var a=this.recv();if(h===0){if(!(a.flags&this.READY)){this.log("client is not ready, waiting...");window.setTimeout(function(){c._send(h,g)},this.WAIT_TIME);return false}}else{if(!((a.flags&this.ACK)&&(a.seqno===this._lastSeqno))){this.log("waiting for ack from client...");window.setTimeout(function(){c._send(h,g)},this.WAIT_TIME);return false}else{this.log("received ack: "+this._lastSeqno+" "+a.seqno)}}var b=this.WRITING;var f=Math.ceil(g.length/this.MAX_DATA_LEN);this.log("num_packets: "+f);if(f===h){this.log("message successfully sent!");this.sendFlag(this.READY|this.ACK,this._lastSeqno);return true}this._lastSeqno++;if(h==f-1){b|=this.FIN}var d=g.substring(h*this.MAX_DATA_LEN,(h+1)*this.MAX_DATA_LEN);var e=this._zerofill(b,4)+this._zerofill(this._lastSeqno,20)+d;this.log("sending raw packet: "+e);this.sendRawPacket(e);return this._send(h+1,g)};FragmentPacket.prototype._zerofill=function(b,d){var a=b.toString();var e=a.length;for(var c=0;c<d-e;c++){a="0"+a}return a};var PostMessagePacket=function(c,a,e,d){var b=this;this.receiver=c;this.receiveCallback=a;this.id=e;this.receiverId=d};PostMessagePacket.prototype.createListener=function(){var a=this;var b=function(d){if(!a.id){a.id=d.data;return}var f=d.data.split(";")[0];if(f!==a.id){return}var c=d.data.substring(d.data.indexOf(";")+1);a.receiveCallback(c)};if(/MSIE/.test(navigator.userAgent)&&typeof window.attachEvent=="function"){window.attachEvent("onmessage",b)}else{if(typeof window.addEventListener=="function"){window.addEventListener("message",b,false)}else{throw new Error("No method found to create event listener for PostMessagePacket.")}}};PostMessagePacket.prototype.send=function(d){var a=false;try{if(typeof this.receiver.id=="undefined"||typeof this.receiver.postMessage=="undefined"){a=true}}catch(c){}if(a&&typeof this.receiverId!="undefined"){this.receiver=document.getElementById(this.receiverId).contentWindow}var b;if(!d){b=this.id}else{b=this.id+";"+d}this.receiver.postMessage(b,"*")};PostMessagePacket._last_unique_id=null;PostMessagePacket._get_unique_id=function(){var a=(new Date()).getTime();if(a==PostMessagePacket._last_unique_id){a++}PostMessagePacket._last_unique_id=a;return a.toString()};var JsonRpc=function(){this.ids={};this.objectToJSON=function(obj){var json="";var results=[];if(obj===undefined||obj===null){return"null"}switch(obj.constructor){case Object:for(var property in obj){if(obj.hasOwnProperty(property)){results.push(this.objectToJSON(property)+": "+this.objectToJSON(obj[property]))}}json="{"+results.join(", ")+"}";break;case Array:for(var i=0;i<obj.length;i++){results.push(this.objectToJSON(obj[i]))}json="["+results.join(", ")+"]";break;case Number:case Boolean:json=obj.toString();break;case String:var specialChars={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"};json=obj.replace(/[\x00-\x1f\\]/g,function(match){var ch=specialChars[match];return ch?ch:"\\u00"+match.charCodeAt().toPaddedString(2,16)});json='"'+json.replace(/"/g,'\\"')+'"';break;default:json="null";break}return json};this.createHandler=function(send_func,registered_funcs){var that=this;var handler=function(message){try{var rpc=eval("("+message+")")}catch(e){alert("bad JSON: "+message);return}if(rpc.method){if(!registered_funcs[rpc.method]){return}var retval=registered_funcs[rpc.method].apply(null,rpc.params);if(rpc.id){var response={result:retval,error:null,id:rpc.id};send_func(that.objectToJSON(response))}}else{if(rpc.result){if(!that.ids[rpc.id]){return}that.ids[rpc.id](rpc.result);delete that.ids[rpc.id]}}};return handler};this.execute=function(send_func,method,params,response_callback){response_callback=response_callback||null;var id=(response_callback)?(new Date()).getTime():null;var request={method:method,params:params,id:id};send_func(this.objectToJSON(request));if(id){this.ids[id]=response_callback}}};JsonRpc=new JsonRpc();var ParentMessenger=function(d,g,a,b){if(navigator.userAgent.indexOf("Safari")>=0&&parseInt(navigator.userAgent.substring(navigator.userAgent.indexOf("Version/")+8),10)==3){throw new Error("unsupported.")}else{if(window.opera){throw new Error("unsupported.")}}if(!g&&navigator.userAgent.indexOf("Gecko")>=0&&parseFloat(navigator.userAgent.slice(navigator.userAgent.indexOf("rv:")+3,navigator.userAgent.indexOf("rv:")+6))<1.9){throw new Error("unsupported.")}if(/msie/i.test(navigator.userAgent)&&!/opera/i.test(navigator.userAgent)){if(document.domain==window.location.hostname){g=""}}var e=this;this.childUrl=d;this.receiverUrl=g;this.container=a||document.body;this.packetHandler=null;this._ready=false;this._error=false;var f=function(){e.receiver=document.createElement("iframe");e.receiver.src=g;e.receiver.id="receiver_"+(new Date()).getTime();e.receiver.name=e.receiver.id;e.receiver.frameBorder="0";e.receiver.frameSpacing="0";e.receiver.style.borderStyle="none";var h=function(){var j=document.getElementById(e.receiver.id).contentWindow;try{j.document.body.innerHTML=""}catch(k){e._error=true}j.document.body.style.padding="0px";j.document.body.style.margin="0px";var l=j.document.createElement("iframe");l.id="child";l.name="child";l.src=e.childUrl;l.frameBorder="0";l.frameSpacing="0";l.style.borderStyle="none";l.style.width="100%";l.style.height="100%";j.document.body.appendChild(l);e.child=j.document.getElementById("child").contentWindow;e.receiver=j;e.packetHandler=new FragmentPacket(e.receiver,e.child,e.childUrl,false,b);e._listener=e.packetHandler.createListener();e.packetHandler.sendFlag(e.packetHandler.READY,0);e._ready=true};e.receiver.onreadystatechange=function(){if(this.readyState=="complete"){h()}};e.receiver.onload=h;if(Dsq.Utils.browser.ie){if(e.container.clientWidth===0){var i=function(){if(e.container.clientWidth>0){Dsq.Utils.fixIframesIE(e.container.id)}else{window.setTimeout(i,100)}};i();e._once=false;e.receiver.onresize=function(){if(!e._once){Dsq.Utils.fixIframesIE(e.container.id)}e._once=true}}}e.container.appendChild(e.receiver)};var c=function(){var h=function(){e.packetHandler.send();e._ready=true};var j=PostMessagePacket._get_unique_id();var i="child_"+j;ParentMessenger["_receiver_onload_"+i]=h;e.container.innerHTML+='<iframe src="'+d+'" id="'+i+'" name="'+i+'" onload="ParentMessenger._receiver_onload_'+i+'();" ></iframe>';e.receiver=document.getElementById(i).contentWindow;e.packetHandler=new PostMessagePacket(e.receiver,b,j,i);e._listener=e.packetHandler.createListener()};if(typeof window.postMessage=="function"){c()}else{f()}};ParentMessenger.prototype.sendMessage=function(b){var a=this;if(!this._ready){window.setTimeout(function(){a.sendMessage(b)},10);return}this.packetHandler.send(b);return true};